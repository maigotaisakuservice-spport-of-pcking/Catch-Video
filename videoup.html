<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catch！ Video - 動画アップロード</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0;
    padding: 0 1rem;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #333;
  }
  h1 {
    margin: 0;
    font-weight: 700;
  }
  #langSwitch {
    cursor: pointer;
    color: #00bcd4;
    font-weight: 600;
  }
  main {
    max-width: 600px;
    margin: 2rem auto;
    background: #1e1e1e;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 12px #00bcd4aa;
  }
  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  input[type="text"],
  textarea,
  input[type="file"] {
    width: 100%;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    margin-bottom: 1rem;
    font-size: 1rem;
    background: #333;
    color: #eee;
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  button {
    background: #00bcd4;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    color: #121212;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    width: 100%;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #progressBarContainer {
    width: 100%;
    background: #333;
    height: 20px;
    border-radius: 12px;
    margin-top: 1rem;
    overflow: hidden;
  }
  #progressBar {
    height: 100%;
    width: 0%;
    background: #00e5ff;
    transition: width 0.3s ease;
  }
  #message {
    margin-top: 1rem;
    font-weight: 600;
    color: #ff4444;
    text-align: center;
  }
  #loginStatus {
    font-size: 0.9rem;
    color: #aaa;
  }
  #logoutBtn {
    background: #f44336;
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.4rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 1rem;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
<header>
  <h1 data-i18n="title">Catch！ Video</h1>
  <div>
    <span id="loginStatus" data-i18n="not_logged_in">未ログイン</span>
    <button id="logoutBtn" style="display:none;" data-i18n="logout">ログアウト</button>
    <span id="langSwitch" style="margin-left:1rem;">EN</span>
  </div>
</header>

<main>
  <form id="uploadForm" aria-label="動画アップロードフォーム">
    <label for="videoFile" data-i18n="select_video">動画ファイルを選択してください</label>
    <input type="file" id="videoFile" accept="video/*" required aria-required="true" />
    
    <label for="titleInput" data-i18n="video_title">動画タイトル</label>
    <input type="text" id="titleInput" placeholder="動画タイトルを入力" required aria-required="true" />
    
    <label for="descriptionInput" data-i18n="video_description">動画説明</label>
    <textarea id="descriptionInput" placeholder="動画の説明を入力"></textarea>
    
    <button type="submit" id="uploadBtn" disabled data-i18n="upload">アップロード</button>
  </form>

  <div id="progressBarContainer" style="display:none;" aria-live="polite" aria-atomic="true">
    <div id="progressBar"></div>
  </div>
  <div id="message"></div>
</main>

<script>
  // --- Firebase初期化 ---
  const firebaseConfig = {
    apiKey: "AIzaSyCionIdr-4M3ZITUlSx8I5i8vmae-c-ldM",
    authDomain: "catch--video.firebaseapp.com",
    projectId: "catch--video",
    storageBucket: "catch--video.firebasestorage.app",
    messagingSenderId: "252815636201",
    appId: "1:252815636201:web:d4da3b738a0e536211e278",
    measurementId: "G-C73B0V1RLN"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // --- i18n ---
  const dictionaries = {
    ja: {
      title: "Catch！ Video",
      not_logged_in: "未ログイン",
      logout: "ログアウト",
      select_video: "動画ファイルを選択してください",
      video_title: "動画タイトル",
      video_description: "動画説明",
      upload: "アップロード",
      uploading: "アップロード中...",
      success: "アップロード成功！",
      error_no_login: "ログインしてください。",
      error_file_size: "動画サイズが上限を超えています。",
      error_file_type: "動画ファイルを選択してください。",
      error_max_videos: "動画アップロード数の上限に達しました。",
      error_upload_failed: "アップロードに失敗しました。",
    },
    en: {
      title: "Catch! Video",
      not_logged_in: "Not logged in",
      logout: "Logout",
      select_video: "Select video file",
      video_title: "Video Title",
      video_description: "Video Description",
      upload: "Upload",
      uploading: "Uploading...",
      success: "Upload successful!",
      error_no_login: "Please log in.",
      error_file_size: "Video file exceeds max size.",
      error_file_type: "Please select a video file.",
      error_max_videos: "Upload video count limit reached.",
      error_upload_failed: "Upload failed.",
    }
  };
  let currentLang = "ja";

  // --- DOM Elements ---
  const loginStatus = document.getElementById("loginStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  const langSwitch = document.getElementById("langSwitch");
  const uploadForm = document.getElementById("uploadForm");
  const videoFileInput = document.getElementById("videoFile");
  const titleInput = document.getElementById("titleInput");
  const descriptionInput = document.getElementById("descriptionInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const progressBarContainer = document.getElementById("progressBarContainer");
  const progressBar = document.getElementById("progressBar");
  const message = document.getElementById("message");

  // --- UIテキスト更新 ---
  function updateText() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.textContent = dictionaries[currentLang][key] || key;
    });
    titleInput.placeholder = currentLang === "ja" ? "動画タイトルを入力" : "Enter video title";
    descriptionInput.placeholder = currentLang === "ja" ? "動画の説明を入力" : "Enter video description";
  }

  langSwitch.addEventListener("click", () => {
    currentLang = currentLang === "ja" ? "en" : "ja";
    langSwitch.textContent = currentLang === "ja" ? "EN" : "日本語";
    updateText();
  });

  // --- ログイン状態 ---
  let currentUser = null;
  let isPremium = false;
  let maxVideoSize = 3 * 1024 * 1024 * 1024; // 3GB default
  let maxVideoCount = 20; // 無料会員

  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    if (user) {
      loginStatus.textContent = user.email;
      logoutBtn.style.display = "inline-block";
      // プレミアム判定API呼び出し
      isPremium = await checkPremiumStatus(user);
      maxVideoSize = isPremium ? 4.5 * 1024 * 1024 * 1024 : 3 * 1024 * 1024 * 1024;
      maxVideoCount = isPremium ? 500 : 20;
      uploadBtn.disabled = false;
    } else {
      loginStatus.textContent = dictionaries[currentLang].not_logged_in;
      logoutBtn.style.display = "none";
      isPremium = false;
      uploadBtn.disabled = true;
    }
    updateText();
  });

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  async function checkPremiumStatus(user) {
    try {
      const token = await user.getIdToken();
      const res = await fetch("https://catchvideo.pcdaimaou.workers.dev/api/user/premium-status", {
        headers: { Authorization: "Bearer " + token }
      });
      if (res.ok) {
        const data = await res.json();
        return data.isPremium === true;
      }
      return false;
    } catch {
      return false;
    }
  }

  // --- ファイル選択時チェック ---
  videoFileInput.addEventListener("change", () => {
    const file = videoFileInput.files[0];
    if (!file) {
      uploadBtn.disabled = true;
      return;
    }
    // 動画ファイル判定
    if (!file.type.startsWith("video/")) {
      message.textContent = dictionaries[currentLang].error_file_type;
      uploadBtn.disabled = true;
      return;
    }
    // サイズ判定
    if (file.size > maxVideoSize) {
      message.textContent = dictionaries[currentLang].error_file_size;
      uploadBtn.disabled = true;
      return;
    }
    message.textContent = "";
    uploadBtn.disabled = false;
  });

  // --- アップロード処理 ---
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    message.textContent = "";
    if (!currentUser) {
      message.textContent = dictionaries[currentLang].error_no_login;
      return;
    }
    const file = videoFileInput.files[0];
    if (!file) {
      message.textContent = dictionaries[currentLang].error_file_type;
      return;
    }
    if (file.size > maxVideoSize) {
      message.textContent = dictionaries[currentLang].error_file_size;
      return;
    }
    // TODO: 動画本数上限チェックAPI呼び出し
    const canUpload = await checkVideoCountLimit(currentUser);
    if (!canUpload) {
      message.textContent = dictionaries[currentLang].error_max_videos;
      return;
    }

    uploadBtn.disabled = true;
    progressBar.style.width = "0%";
    progressBarContainer.style.display = "block";

    try {
      const token = await currentUser.getIdToken();

      // Cloudflare Workerへファイル送信
      const formData = new FormData();
      formData.append("video", file);
      formData.append("title", titleInput.value.trim());
      formData.append("description", descriptionInput.value.trim());

      const res = await fetch("https://catchvideo.pcdaimaou.workers.dev/api/upload", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token
        },
        body: formData
      });

      if (!res.ok) throw new Error("Upload failed");

      message.style.color = "#00ff88";
      message.textContent = dictionaries[currentLang].success;

      // リセット
      uploadForm.reset();
      uploadBtn.disabled = false;
      progressBarContainer.style.display = "none";
      progressBar.style.width = "0%";
    } catch (err) {
      message.style.color = "#ff4444";
      message.textContent = dictionaries[currentLang].error_upload_failed;
      uploadBtn.disabled = false;
      progressBarContainer.style.display = "none";
      progressBar.style.width = "0%";
    }
  });

  // --- 動画本数チェック（API仮実装） ---
  async function checkVideoCountLimit(user) {
    try {
      const token = await user.getIdToken();
      const res = await fetch("https://catchvideo.pcdaimaou.workers.dev/api/user/video-count", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) return false;
      const data = await res.json();
      return (data.count < maxVideoCount);
    } catch {
      return false;
    }
  }

  updateText();
</script>
</body>
</html>
